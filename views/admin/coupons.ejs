<%- include("../../views/partials/admin/header") %>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f8f9fa;
  }

  .content-main {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .content-header {
    margin-bottom: 20px;
  }

  .content-title {
    font-size: 1.8rem;
    font-weight: 600;
    color: #333;
  }

  .table {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
  }

  .table th,
  .table td {
    padding: 10px;
    text-align: left;
  }

  .table th {
    background-color: #007bff;
    color: #fff;
    font-weight: 600;
  }

  .table-striped tbody tr:nth-child(odd) {
    background-color: #f8f9fa;
  }

  .badge {
    padding: 5px 10px;
    border-radius: 10px;
    font-size: 0.85rem;
  }

  .alert-success {
    background-color: #28a745;
    color: #fff;
  }

  .alert-danger {
    background-color: #dc3545;
    color: #fff;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-label {
    font-weight: 500;
    margin-bottom: 5px;
    color: #333;
  }

  .form-control {
    width: 100%;
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.95rem;
  }

  .form-control:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
  }

  .error-message {
    color: #dc3545;
    font-size: 0.85rem;
    margin-top: 5px;
  }

  .btn-primary {
    background-color: #007bff;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    font-size: 0.95rem;
  }

  .btn-primary:hover {
    background-color: #0056b3;
  }

  .btn-danger.btn-sm {
    background-color: #dc3545;
    color: #fff;
    padding: 6px 12px;
    font-size: 0.85rem;
  }

  .btn-danger.btn-sm:hover {
    background-color: #c82333;
  }

  .btn-primary.btn-sm {
    background-color: #007bff;
    color: #fff;
    padding: 6px 12px;
    font-size: 0.85rem;
  }

  .btn-primary.btn-sm:hover {
    background-color: #0056b3;
  }

  @media (max-width: 768px) {
    .table {
      font-size: 0.85rem;
    }
    .table th,
    .table td {
      padding: 8px;
    }
  }
</style>

<!-- SweetAlert CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css" />

<section class="content-main">
  <!-- Coupon Section -->
  <div class="content-header row">
    <div class="d-flex justify-content-between align-items-center">
      <h2 class="content-title card-title">Coupons</h2>
    </div>
  </div>
  <div class="row">
    <div class="col-md-4">
      <form id="createCouponForm" method="post" action="/admin/createCoupon">
        <body onload="setDefaultStartDate()"></body>
        <div class="form-group">
          <label for="coupon-name" class="form-label">Coupon Name</label>
          <input
            type="text"
            id="coupon-name"
            name="couponName"
            placeholder="Type here"
            class="form-control"
          />
          <div id="error-coupon-name" class="error-message"></div>
        </div>
        <div class="form-group">
          <label for="startingDate" class="form-label">Start Date</label>
          <input
            type="date"
            name="startDate"
            class="form-control"
            required="true"
            id="startingDate"
          />
          <div id="error-start-date" class="error-message"></div>
        </div>
        <div class="form-group">
          <label for="expiringDate" class="form-label">End Date</label>
          <input
            type="date"
            name="endDate"
            class="form-control"
            id="expiringDate"
            required="true"
          />
          <div id="error-end-date" class="error-message"></div>
        </div>
        <div class="form-group">
          <label for="offer-price" class="form-label">Offer Price</label>
          <input
            type="text"
            name="offerPrice"
            placeholder="Type here"
            class="form-control"
          />
          <div id="error-offer-price" class="error-message"></div>
        </div>
        <div class="form-group">
          <label for="minimum-price" class="form-label">Minimum Price</label>
          <input
            type="text"
            name="minimumPrice"
            placeholder="Type here"
            class="form-control"
          />
          <div id="error-minimum-price" class="error-message"></div>
        </div>
        <div class="form-group">
          <button
            class="btn btn-primary"
            type="submit"
          >
            Add Coupon
          </button>
        </div>
        <div id="err-msg" class="error-message"></div>
      </form>
    </div>
    <div class="col-md-8">
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Created On</th>
            <th scope="col">Expires On</th>
            <th scope="col">Offer Price</th>
            <th scope="col">Minimum Price</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% for(let i = 0; i < coupons.length; i++) { %>
            <tr>
              <td><%= coupons[i].name %></td>
              <td><%= new Date(coupons[i].createdOn).toLocaleDateString('en-IN') %></td>
              <td><%= new Date(coupons[i].expireOn).toLocaleDateString('en-IN') %></td>
              <td><%= coupons[i].offerPrice %></td>
              <td><%= coupons[i].minimumPrice %></td>
              <td>
                <span class="badge rounded-pill <%= coupons[i].isList ? 'alert-success' : 'alert-danger' %>">
                  <%= coupons[i].isList ? 'Active' : 'Inactive' %>
                </span>
              </td>
              <td>
                <a href="/admin/editCoupon?id=<%= coupons[i]._id %>" class="btn btn-primary btn-sm">Edit</a>
                <a href="#" onclick="confirmDelete('<%= coupons[i]._id %>')" class="btn btn-danger btn-sm">Delete</a>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<!-- jQuery (required for deleteCoupon AJAX) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  // Success/error message handling
  document.addEventListener('DOMContentLoaded', function () {
    const successMessage = '<%= typeof successMessage !== "undefined" ? successMessage : "" %>';
    const errorMessage = '<%= typeof errorMessage !== "undefined" ? errorMessage : "" %>';

    if (successMessage) {
      Swal.fire({
        title: 'Success!',
        text: successMessage,
        icon: 'success',
        confirmButtonText: 'OK',
        confirmButtonColor: '#007bff'
      });
    }

    if (errorMessage) {
      Swal.fire({
        title: 'Error',
        text: decodeURIComponent(errorMessage),
        icon: 'error',
        confirmButtonColor: '#dc3545'
      });
    }
  });

  function validateForm(event) {
    event.preventDefault(); // Prevent form submission until validation
    document.querySelectorAll(".error-message").forEach((element) => (element.innerHTML = ""));

    // Get form values
    const name = document.getElementsByName("couponName")[0].value.trim();
    const sDate = document.getElementsByName("startDate")[0].value;
    const eDate = document.getElementsByName("endDate")[0].value;
    const offerPrice = document.getElementsByName("offerPrice")[0].value.trim();
    const minimumPrice = document.getElementsByName("minimumPrice")[0].value.trim();

    let isValid = true;
    let errorMessages = [];

    // Coupon Name: 1-50 chars, alphanumeric
    const nameRegex = /^[A-Za-z0-9]{1,50}$/;
    if (!name) {
      document.getElementById("error-coupon-name").innerHTML = "Coupon name is required";
      errorMessages.push("Coupon name is required");
      isValid = false;
    } else if (!nameRegex.test(name)) {
      document.getElementById("error-coupon-name").innerHTML = "Coupon name must be 1-50 alphanumeric characters";
      errorMessages.push("Coupon name must be 1-50 alphanumeric characters");
      isValid = false;
    }

    // Start Date: Required, >= today
    if (!sDate) {
      document.getElementById("error-start-date").innerHTML = "Start date is required";
      errorMessages.push("Start date is required");
      isValid = false;
    } else {
      const sDateObj = new Date(sDate);
      const todayDateObj = new Date();
      todayDateObj.setHours(0, 0, 0, 0);
      if (sDateObj < todayDateObj) {
        document.getElementById("error-start-date").innerHTML = "Start date must be today or later";
        errorMessages.push("Start date must be today or later");
        isValid = false;
      }
    }

    // End Date: Required, > start date
    if (!eDate) {
      document.getElementById("error-end-date").innerHTML = "End date is required";
      errorMessages.push("End date is required");
      isValid = false;
    } else {
      const sDateObj = new Date(sDate);
      const eDateObj = new Date(eDate);
      if (sDate && eDate && sDateObj >= eDateObj) {
        document.getElementById("error-end-date").innerHTML = "End date must be after start date";
        errorMessages.push("End date must be after start date");
        isValid = false;
      }
    }

    // Offer Price: Required, numeric, >10, < minimumPrice
    if (!offerPrice) {
      document.getElementById("error-offer-price").innerHTML = "Offer price is required";
      errorMessages.push("Offer price is required");
      isValid = false;
    } else if (!/^\d+$/.test(offerPrice)) {
      document.getElementById("error-offer-price").innerHTML = "Offer price must be a positive integer";
      errorMessages.push("Offer price must be a positive integer");
      isValid = false;
    } else {
      const offerPriceNum = parseInt(offerPrice);
      if (offerPriceNum <= 10) {
        document.getElementById("error-offer-price").innerHTML = "Offer price must be above 10 rupees";
        errorMessages.push("Offer price must be above 10 rupees");
        isValid = false;
      }
    }

    // Minimum Price: Required, numeric, > offerPrice
    if (!minimumPrice) {
      document.getElementById("error-minimum-price").innerHTML = "Minimum price is required";
      errorMessages.push("Minimum price is required");
      isValid = false;
    } else if (!/^\d+$/.test(minimumPrice)) {
      document.getElementById("error-minimum-price").innerHTML = "Minimum price must be a positive integer";
      errorMessages.push("Minimum price must be a positive integer");
      isValid = false;
    } else {
      const offerPriceNum = parseInt(offerPrice);
      const minimumPriceNum = parseInt(minimumPrice);
      if (offerPrice && minimumPrice && !isNaN(offerPriceNum) && !isNaN(minimumPriceNum) && offerPriceNum >= minimumPriceNum) {
        document.getElementById("error-offer-price").innerHTML = "Offer price must be less than minimum price";
        errorMessages.push("Offer price must be less than minimum price");
        isValid = false;
      }
    }

    if (!isValid) {
      Swal.fire({
        icon: 'error',
        title: 'Validation Error',
        text: errorMessages.join(' '),
        confirmButtonColor: '#dc3545'
      });
      return false;
    }

    // Submit form if valid
    document.getElementById("createCouponForm").submit();
    return true;
  }

  function confirmDelete(couponId) {
    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, delete it!",
    }).then((result) => {
      if (result.isConfirmed) {
        deleteCoupon(couponId);
      }
    });
  }

  function deleteCoupon(couponId) {
    $.ajax({
      url: `/admin/deletecoupon?id=${couponId}`,
      method: "GET",
      success: function () {
        Swal.fire({
          icon: "success",
          title: "Deleted!",
          text: "The coupon has been deleted.",
          confirmButtonText: "OK",
        }).then(() => {
          window.location.reload();
        });
      },
      error: function () {
        Swal.fire({
          icon: "error",
          title: "Error!",
          text: "Failed to delete the coupon. Please try again.",
        });
      },
    });
  }

  function setDefaultStartDate() {
    const today = new Date();
    const year = today.getFullYear();
    let month = (today.getMonth() + 1).toString().padStart(2, "0");
    let day = today.getDate().toString().padStart(2, "0");
    document.getElementById("startingDate").value = `${year}-${month}-${day}`;
  }
</script>

<%- include("../../views/partials/admin/footer") %>